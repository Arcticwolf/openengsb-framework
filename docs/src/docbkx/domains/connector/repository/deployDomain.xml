<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--

    Copyright 2010 OpenEngSB Division, Vienna University of Technology

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->

<chapter id="deployDomain" xmlns="http://docbook.org/ns/docbook">
  <title id="deployDomain.title">Deploy Domain</title>

  <warning>
    <para>
      This page is only a proposal! This means that everyone is allowed to edit this page and it is 
      marked for change. This proposal could be seen as design idea and should be discussed in public
      and visible for everyone before implemented at all.
    </para>
  </warning>

  <para>
    This Document describes a generic interface to the deploy domain to be used in engsb.
    To determine the required functionality it has to provide the tools and protocols SCP, HTTP, Maven, Nexus, Archiva and WebDAV were examined.
  </para> 

  <section>
    <title>Comparison</title>
    
    <informaltable>
      <thead>
        <tr>
          <td>Tool</td>
          <td>Functionality</td>
          <td>Required parameters</td>
          <td>Optional parameters</td>
          <td>Comments</td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>SCP</td>
          <td>Move local file(s) to remote host</td>
          <td>(list of) local file(s) and URI to remote location</td>
          <td>User's credentials</td>
          <td>Done with standard SCP call</td>
        </tr>
        <tr>
          <td>HTTP</td>
          <td>Move local file to remote host</td>
          <td>local file and URI to remote location</td>
          <td>User's credentials</td>
          <td>Done with <ulink url="http://hc.apache.org/httpclient-3.x/methods/put.html">HTTP Client's PUT-Method</ulink></td>
        </tr>
        <tr>
          <td>Maven deploy:deploy-file</td>
          <td>Deploy local file to remote repository; It is used to import third party jars into a (maven-)repository and does not seem to be intended to work on arbitrary files or arbitrary repositories</td>
          <td>file, repositoryId, repositoryLayout, url; also see the <ulink url="http://maven.apache.org/plugins/maven-deploy-plugin/deploy-file-mojo.html">documentation</ulink></td>
          <td>artifactId, classifier, description, generatePom, groupId, packaging, pomFile, uniqueVersion, version; also see the <ulink url="http://maven.apache.org/plugins/maven-deploy-plugin/deploy-file-mojo.html">documentation</ulink></td>
          <td>Done with <ulink url="http://maven.apache.org/plugins/maven-deploy-plugin/apidocs/index.html?index-all.html">DeployFileMojo</ulink></td>
        </tr>
        <tr>
          <td>Maven deploy:deploy</td>
          <td>Move local maven-artifact to remote maven-repository</td>
          <td>none, need to be supplied in pom-file; also see the <ulink url="http://maven.apache.org/plugins/maven-deploy-plugin/deploy-mojo.html">documentation</ulink></td>
          <td>altDeploymentRepository, skip, updateReleaseInfo; also see the <ulink url="http://maven.apache.org/plugins/maven-deploy-plugin/deploy-mojo.html">documentation</ulink></td>
          <td>Done with <ulink url="http://maven.apache.org/plugins/maven-deploy-plugin/apidocs/index.html?index-all.html">DeployMojo</ulink></td>
        </tr>
        <tr>
          <td>Nexus</td>
          <td>Maven deploy-functionality; Move artifact to Nexus-repository</td>
          <td>see Maven deploy</td>
          <td>see Maven deploy</td>
          <td>also see <ulink url="http://svn.sonatype.org/m2eclipse/trunk/org.maven.ide.eclipse.book/book/ch14s06.html">this article</ulink></td>
        </tr>
        <tr>
          <td>Archiva</td>
          <td>Maven deploy-functionality; Move artifact to Archiva-repository</td>
          <td>pom-file entries; see <ulink url="http://archiva.apache.org/docs/1.1.2/userguide/deploy.html">this article</ulink></td>
          <td>no additional</td>
          <td> </td>
        </tr>
        <tr>
          <td>WebDAV</td>
          <td>Maven deploy functionality over webDAV</td>
          <td>additionally needs special pom-file entries; see <ulink url="http://archiva.apache.org/docs/1.1.2/userguide/deploy.html">this article</ulink></td>
          <td>no additional</td>
          <td>This is not a standalone usecase. DAV is rather utilized as protocol</td>
        </tr>
      </tbody>
    </informaltable>
  </section>
  
  <section>
    <title>Comparison of tools to deploy to/with</title>
    
    <para>
      So, where does this lead us? The general purpose file-transferring protocols SCP and HTTP simply need a local file, the remote
      host plus the path on the remote system (= URI) and possibly some user's credentials. The Maven-based deploy-usecases all need a
      pom-file for each artifact, that shall be deployed. This leads to the conclusion, that the common dynamic functionality is simply to
      trigger the deploy at all, while all other information will have to be retrieved from static config files (pom-files and/or SU-configuration).
      However, the deploy-process is usually set up once and does not change much. If at all, it's configuration is extended every now and then. Thus,
      modeling the domain rather static should not yield a big problem.
      Let's further examine the details in the Interface section.
    </para>
  </section>
  
  <section>
    <title>Interface</title>
    
    <para>
      As concluded in the comparison the interface only needs to support the actual triggering of the deploy-process.
      This means, that the SU's configuration must hold a list of files/artifacts, that shall be deployed. In the case of SCP and HTTP, we'll
      aditionally need the URI where to deploy to (possibly per file) and probably user credentials.
      For The Maven-based aproaches, we'll simply need to maintain a list of pom-files in the SU.
    </para>
    
    <section>
      <title>Interface methods</title>
      
      <programlisting><![CDATA[/**
 * Deploys all files listed in the SU's configuration.
 * @return A List of DeployResults, containing an entry for every deployed file, describing the success for this deploy-attempt.
 * @throws DeployException for a generic indication of failure while deploying.
 */
  public List<DeployResult> execute() throws DeployException;

/**
 * Deploys all files listed in the SU's configuration asynchronously.
 * @throws DeployException for a generic indication of failure while deploying.
 */
  public void executeAsynchronous() throws DeployException;

/**
 * Deploys a single file. The file must exist and be configured in the SU. 
 * @param file The file to be deployed. A list of files, that may be used for this call can be obtained from listFileToDeploy().
 * @return The DeployResult describing the success for this deploy-attempt.
 * @throws DeployException for a generic indication of failure while deploying.
 */
  public DeployResult deployFile (String file) throws DeployException;

/**
 * Deploys a single file. The file must exist and be configured in the SU. 
 * @param file The file to be deployed. A list of files, that may be used for this call can be obtained from listFileToDeploy().
 * @throws DeployException for a generic indication of failure while deploying.
 */
  public void deployFileAsynchronous (String file) throws DeployException;

/**
 * Returns a list of files, configured in the SU.
 * @return A list of configured files.
 */
  public String[] listFilesToDeploy();]]></programlisting>
  
  </section>
  
  <section>
    <title>Datatypes</title>
    
    <programlisting><![CDATA[public class DeployResult {
	private String	file;
	private String	errorMessage;
	private boolean	success;
	
	public String getFile ()
	{
		return file;
	}
	public String getErrorMessage()
	{
		return errorMessage;
	}
	public boolean wasSuccessful()
	{
		return success;
	}
	public void setFile (String file)
	{
		this.file = file;
	}
	public void setErrorMessage (String errorMessage)
	{
		this.errorMessage = errorMessage;
	}
	public void setSuccess (boolean success)
	{
		this.success = success;
	}
}]]></programlisting>

  </section>
  
  <section>
    <title>Events</title>
    
    <programlisting><![CDATA[DeployExecuted {
	private Date				timestamp;
	private List<DeployResult>	results;
	
	/* with appropriate getters and setters */
}]]></programlisting>

  Triggered on every deploy*-call to notify everybody who wants to know about a deploy.
  </section>
  
</section>
</chapter>
