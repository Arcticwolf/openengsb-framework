<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--

    Copyright 2010 OpenEngSB Division, Vienna University of Technology

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->

<chapter id="tracIssueConnector" xmlns="http://docbook.org/ns/docbook">
  <title id="tracIssueConnector.title">Trac Issue Connector</title>

  <para>
    This connector enables OpenEngSB to create issues on a trac instance. You will need to install the
    <ulink url="http://trac-hacks.org/wiki/XmlRpcPlugin">XmlRpc Plugin</ulink> on your trac instance.
  </para>
  
  <para>
    The connector implements following methods of the issue domain:
    
    <itemizedlist>
      <listitem>createIssue</listitem>
      <listitem>addComment</listitem>
      <listitem>updateIssue</listitem>
      <listitem>deleteIssue</listitem>
    </itemizedlist>
  
  Each project will need it's own endpoint and configuration.
  
  </para>
  
  <section>
    <title>Setup</title>
    
    <section>
      <title>DroolsSetup</title>
      
      <para>
        To create rules for the issue domain you will need to add following imports to drools:
        Edit <filename>$SERVICEMIX_HOME/data/openengsb/rulebase/imports</filename> and
        <filename>$SERVICEMIX_HOME/data/openengsb/rulebase/globals</filename>.
      </para>
      
      <programlisting>import java.util.HashMap
import org.openengsb.drools.IssuesDomain
import org.openengsb.drools.model.Issue
</programlisting>

      <programlisting>global org.openengsb.drools.IssuesDomain issue</programlisting>
      
    </section>
    
    <section>
      <title>Configuring a SU for your Project</title>
      
      <para>
        The connector needs some parameters to connect to your project's trac instance which are configured
        in the SU's xbean.xml file. Replace USERNAME, PASSWORD, URL, PORT, PROJECTNAME with your specific settings.
      </para>
      
      <programlisting><![CDATA[<bean id="config" class="org.apache.xmlrpc.client.XmlRpcClientConfigImpl">
    <property name="serverURL" value="http://URL:PORT/PROJECTNAME/login/xmlrpc" />
    <property name="basicUserName" value="USERNAME" />
    <property name="basicPassword" value="PASSWORD" />
  </bean>]]></programlisting>

      <para>
        You will also need to set a unique servicename for your project to create drool rules later.
        Replace SERVICENAME with an appropriate servicename for your Project. e.g: "tracOpenEngSBService".
      </para>
      
      <programlisting><![CDATA[<trac:tracEndpoint service="trc:SERVICENAME" endpoint="tracEndpoint"
        tracConnector="#tracConnector" />]]></programlisting>

    </section>
    
    <section>
      <title>Adding your endpoint to the contextstore</title>

      <para>
        Finally you will have to add your projects servicepoint to the contextstore.
        Insert following lines to the loadIssueConfig() method in contextstore.java (openengsb-core) and replace
        SERVICENAME(from the xbean.xml), CONTEXTSTORENAME.
      </para>
      
      <programlisting>setValue("42/issue/CONTEXTSTORENAME/namespace", "urn:openengsb:trac");
  setValue("42/issue/CONTEXTSTORENAME/servicename", "SERVICENAME");</programlisting>

    </section>
  </section>
  
  <section>
    <title>Multiple Projects</title>

    <para>
      If you want to create Issues for multiple projects, you will have to create one Service-Unit per project.
      Repeat the setup for each project and be carefull to choose unique SERVICE- and CONTEXTSTORENAME's
    </para>
  </section>
  
  <section>
    <title>Drools example rule</title>
    
    <para>
      With config.setToConnector(issue, "CONTEXTSTORENAME") you can switch your projects tracConnector
    </para>
    
    <section>
      <title>Example for creating an issue</title>
      
      <programlisting><![CDATA[when
   e : Event( name == "tracOpenEngSBcreate" )
then
   config.setToConnector(issue, "tracOpenEngSB");
   Issue i = new Issue();
   i.setSummary("Test Summary");
   i.setDescription("Test Description");
   i.setReporter("user");
   i.setPriority(Issue.priorityURGENT);
   issue.createIssue(i);]]></programlisting>

    </section>
    
    <section>
      <title>Example for updating an issue</title>
      
      <programlisting><![CDATA[dialect 'java'
when
    e : Event( name == "tracOpenEngSBcreate" )
then
   HashMap<String, Object> changes = new HashMap<String, Object>();
   changes.put(Issue.fieldPRIORITY, Issue.priorityNORMAL);
   issue.updateIssue(2, "Update comment", changes);]]></programlisting>

   </section>
</section>

</chapter>
